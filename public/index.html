<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMP Server - Login & Chat</title>
  
  <style>
    /* --------------------------------
     * 1. ANIMACIONES & BASE (Pintura Viva)
     * -------------------------------- */
    @keyframes movement { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }
    @keyframes twinkle { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.7); } }
    
    body {
      margin: 0; height: 100vh;
      display: flex; justify-content: center; align-items: center;
      font-family: Arial, sans-serif; overflow: hidden; color: #fff;
      
      background: radial-gradient(circle at 30% 30%, #ff69b470, transparent 30%),
                  radial-gradient(circle at 70% 70%, #00ffff70, transparent 30%),
                  linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      background-blend-mode: screen; background-size: 300% 300%;
      animation: movement 60s linear infinite alternate;
    }

    body::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: repeating-radial-gradient(#ffffff80, #ffffff80 1px, transparent 1px, transparent 20px);
      background-size: 20px 20px;
      animation: twinkle 5s ease-in-out infinite alternate; z-index: -1;
    }

    /* --------------------------------
     * 2. CONTENEDOR Y FORMULARIO (LOGIN)
     * -------------------------------- */
    .container {
      background: rgba(0,0,0,0.85); padding: 30px 40px; border-radius: 15px;
      text-align: center; box-shadow: 0 0 40px #ff69b4; border: 1px solid #00ffff;
      z-index: 10; width: 90%; max-width: 500px;
    }
    #login-container { max-width: 350px; } 

    h1 { margin-bottom: 25px; color: #00ffff; }
    #password { display: none; } 
    #loginButton { display: none; } 

    input {
      width: calc(100% - 20px); padding: 10px; margin: 10px 0; border: none;
      border-radius: 8px; background: #333; color: #fff; font-size: 1em;
    }

    button {
      width: 100%; padding: 10px; margin-top: 10px; background: #ff69b4; border: none;
      border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s;
      font-size: 1em;
    }
    button:hover { background: #ff1493; box-shadow: 0 0 10px #ff1493; }

    /* --------------------------------
     * 3. ESTILOS DEL CHAT Y RANGOS
     * -------------------------------- */
    #chat-messages {
      border: 1px solid #00ffff; height: 300px; overflow-y: scroll;
      margin-bottom: 15px; padding: 10px; background: rgba(0, 0, 0, 0.6);
      text-align: left;
    }
    #chat-messages p { margin: 5px 0; font-size: 0.9em; line-height: 1.3; }
    
    /* Colores para Rangos */
    .rank-Admin { color: #ff0000; font-weight: bold; } 
    .rank-Moderador { color: #ffcc00; } 
    .rank-VIP { color: #00ff00; } 
    .rank-Usuario { color: #8888ff; }
    .rank-System { color: #999; }
    
    #chat-messages .rank-tag { margin-right: 5px; } 
    #chat-messages b { color: #ff69b4; font-weight: bold; }
    
    /* Input y bot√≥n del Chat */
    #chat-input-container { display: flex; gap: 10px; }
    #chat-input-container input { flex-grow: 1; margin: 0; }
    #chat-input-container button { width: 100px; margin: 0; flex-shrink: 0; }

  </style>
</head>
<body>
  
  <div id="login-container" class="container">
    <h1>Iniciar Sesi√≥n</h1>
    <form id="loginForm">
      <input type="text" id="username" placeholder="Usuario (Oliver, Keko.imp, etc.)" required>
      <input type="password" id="password" placeholder="Contrase√±a (Oculta)" required> 
      <button id="loginButton" type="submit">Entrar</button>
    </form>
    <p id="message"></p>
  </div>

  <div id="chat-container" class="container" style="display:none;">
    <h1 id="chat-title">Chat Global</h1>
    
    <div id="chat-messages">
        </div>
    
    <div id="chat-input-container">
        <input type="text" id="msg" placeholder="Escribe tu mensaje..." required>
        <button onclick="sendMessage()">Enviar</button>
    </div>
    
    <button onclick="logout()" style="background:#b21f1f; margin-top: 20px; max-width: 150px; float: right;">Salir</button>
  </div>

  <script>
    // Variables y Mapeo de RANGOS (JS)
    const loginContainer = document.getElementById("login-container");
    const chatContainer = document.getElementById("chat-container");
    const message = document.getElementById("message");
    const usernameInput = document.getElementById("username");
    const chatBox = document.getElementById('chat-messages');
    const msgInput = document.getElementById('msg');
    
    let currentAlias = null; 
    let currentRank = null; 
    let isProcessingLogin = false; 
    let loginTimeoutId = null; 
    let pollingIntervalId = null; // Para detener la actualizaci√≥n peri√≥dica

    // üîë DATA DE USUARIOS Y RANGOS (Control total desde Index.html)
    const USER_DATA = {
        "oliver": { alias: "Oliver", rank: "Admin" },
        "keko.imp": { alias: "Keko.IMP", rank: "Moderador" },
        "aye_russu": { alias: "Aye_Russu", rank: "VIP" },
        "atlas": { alias: "Atlas", rank: "Usuario" }
    };
    
    // --------------------- FUNCI√ìN DE CHAT DOM ---------------------

    function addMessageToDOM(alias, text, rank = 'Usuario') {
        const newMessage = document.createElement('p');
        const rankClass = rank.replace(/\s/g, ''); 
        
        newMessage.innerHTML = `<span class="rank-${rankClass} rank-tag">[${rank}]</span> <b>${alias}</b>: ${text}`;
        
        chatBox.appendChild(newMessage);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // NUEVO: Pide la lista de mensajes al servidor Termux y los carga
    async function fetchAndLoadMessages() {
        try {
            // üí° USAMOS RUTA RELATIVA: El navegador a√±adir√° autom√°ticamente la IP y el puerto de Termux.
            const response = await fetch('/messages'); 
            const messages = await response.json();
            
            // Si el n√∫mero de mensajes ha cambiado, limpiamos y recargamos.
            if (chatBox.children.length !== messages.length + 1) { // +1 por el mensaje de bienvenida
                
                chatBox.innerHTML = ''; // Limpiar antes de cargar
            
                messages.forEach(msg => {
                    addMessageToDOM(msg.alias, msg.text, msg.rank);
                });

                // A√±adimos el mensaje de bienvenida al final (despu√©s de cargar el historial)
                addMessageToDOM("Sistema", `Historial cargado.`, 'System');
            }
            
        } catch (error) {
            console.error('Error al cargar mensajes. ¬øEst√° Termux corriendo?', error);
            // Si hay error de conexi√≥n, el mensaje de bienvenida lo manejar√° al inicio.
        }
    }

    // --------------------- FUNCI√ìN: INICIAR CHAT ---------------------
    function startChat(userData) {
        currentAlias = userData.alias;
        currentRank = userData.rank;
        
        document.getElementById('chat-title').innerHTML = `Chat Global - Conectado como: <span class="rank-${currentRank.replace(/\s/g, '')}">${currentAlias}</span>`;
        
        loginContainer.style.display = 'none';
        chatContainer.style.display = 'block';
        
        msgInput.focus();
        isProcessingLogin = false; 
        
        // üí° Cargar mensajes del SERVIDOR
        addMessageToDOM("Sistema", `Intentando conectar con servidor en Termux...`, 'System');
        fetchAndLoadMessages();

        // Configurar un intervalo para actualizar mensajes cada 3 segundos (Polling)
        pollingIntervalId = setInterval(fetchAndLoadMessages, 3000); 
    }

    // --------------------- FUNCI√ìN: MANEJAR LOGIN AUTOM√ÅTICO ---------------------
    function handleAutoLogin() {
      if (isProcessingLogin) return;

      const inputUsername = usernameInput.value.trim();
      const normalizedUsername = inputUsername.toLowerCase(); 

      if (inputUsername.length === 0) {
          message.textContent = '';
          return;
      }
      
      if (loginTimeoutId) {
          clearTimeout(loginTimeoutId);
      }

      if(USER_DATA.hasOwnProperty(normalizedUsername)){
        
        isProcessingLogin = true; 
        usernameInput.disabled = true;
        
        message.textContent = "üîÑ Verificando...";
        message.style.color = "#00ffff"; 
        
        const userData = USER_DATA[normalizedUsername];
        
        loginTimeoutId = setTimeout(() => {
          
          message.textContent = `‚úÖ Usuario verificado. Iniciando chat...`;
          message.style.color = "lightgreen";
          
          startChat(userData); 
          
        }, 1500); 
        
      } else {
        message.textContent = "‚ùå Usuario no registrado.";
        message.style.color = "red";
      }
    }
    
    // --------------------- ENV√çO DE MENSAJES AL SERVIDOR ---------------------
    
    async function sendMessage() {
        const text = msgInput.value.trim();

        if (text === '') return;
        
        const messageData = {
            alias: currentAlias,
            text: text,
            rank: currentRank
        };

        try {
            // üí° Enviar el mensaje al servidor Termux (POST)
            const response = await fetch('/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(messageData)
            });

            if (response.ok) {
                // Si el servidor lo guard√≥, actualizamos inmediatamente
                fetchAndLoadMessages();
            } else {
                addMessageToDOM("Sistema", "Error al enviar mensaje. Servidor no respondi√≥.", 'System');
            }

        } catch (error) {
            console.error('Error de red al enviar:', error);
            addMessageToDOM("Sistema", "Error de conexi√≥n al enviar mensaje.", 'System');
        }

        msgInput.value = '';
        msgInput.focus();
    }
    
    // --------------------- LOGOUT ---------------------
    function logout() {
        // Detener la actualizaci√≥n autom√°tica de mensajes
        if (pollingIntervalId) {
            clearInterval(pollingIntervalId);
            pollingIntervalId = null;
        }

        currentAlias = null;
        currentRank = null;
        isProcessingLogin = false;
        
        chatContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        
        usernameInput.disabled = false;
        usernameInput.value = '';
        message.textContent = '';
        usernameInput.focus();
        
        chatBox.innerHTML = ''; 
    }

    // --------------------- LISTENERS ---------------------
    usernameInput.addEventListener("input", handleAutoLogin);
    document.getElementById("loginForm").addEventListener("submit", function(e) { e.preventDefault(); });
    msgInput.addEventListener("keypress", function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });

  </script>
</body>
</html>
