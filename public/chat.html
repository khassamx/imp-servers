<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat IMP</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  
  <audio id="background-music" loop>
    <source src="/assets/retro_theme.mp3" type="audio/mpeg">
  </audio>

  <h2>💀 Chat IMP</h2>
  <div id="messages"></div>
  <input type="text" id="msg" placeholder="Escribe un mensaje..." autocomplete="off">
  <button onclick="sendMessage()">Enviar</button>

  <script>
    let username = localStorage.getItem("username");
    if (!username) window.location.href = "/";
    
    let currentMessageCount = 0; 
    let messagesContainer = document.getElementById("messages");

    // LÓGICA DE MÚSICA CONTINUA
    const audio = document.getElementById("background-music");
    const storedPosition = localStorage.getItem("musicPosition");

    if (storedPosition) {
        audio.currentTime = parseFloat(storedPosition);
        audio.play().catch(error => {});
        localStorage.removeItem("musicPosition");
    } else {
        audio.play().catch(e => {});
    }

    // LÓGICA DE CARGA DE CHAT (código de carga incremental)
    async function loadMessages() {
      // ... (código loadMessages sin cambios)
      let res = await fetch(`/messages?lastIndex=${currentMessageCount}`);
      let data = await res.json();
      
      const newMessages = data.messages;

      if (newMessages.length > 0) {
          const html = newMessages.map(m => 
              `<p><b>${m.username}</b>: ${m.translatedText} <small>[${m.text}]</small></p>`
          ).join("");
          
          messagesContainer.innerHTML += html;
          
          currentMessageCount = data.totalCount;
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }

    async function sendMessage() {
      let text = document.getElementById("msg").value.trim();
      if (!text) return;

      // Optimización: Mostrar el mensaje inmediatamente antes de la respuesta del servidor
      const temporaryMessage = document.createElement('p');
      temporaryMessage.innerHTML = `<b>${username}</b>: (Enviando...) ${text}`;
      messagesContainer.appendChild(temporaryMessage);
      messagesContainer.scrollTop = messagesContainer.scrollHeight; // SCROLL UX

      await fetch("/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, text })
      });

      document.getElementById("msg").value = "";
      // El siguiente loadMessages recargará y reemplazará el "(Enviando...)" con la traducción.
      loadMessages(); 
    }
    
    // Habilitar la tecla ENTER
    document.getElementById("msg").addEventListener("keypress", function(event) {
      if (event.key === 'Enter') { 
        sendMessage();
      }
    });

    setInterval(loadMessages, 2000); 
    loadMessages();
  </script>
</body>
</html>